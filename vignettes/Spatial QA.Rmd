---
title: "Using Population Data for Spatial QA of MEMAs"
author: "Mark Dane"
date: "May 22, 2015"
output: pdf_document
---

This report shows the development of a spatial QA metrics using Tecan populatio data. Print blocks and neighborhood areas are the first to be interrogated. The CellMask signal on the LI8V00407_14 plates are used. This signal will be interpreted as linearly correlating to cell number.



```{r load libraries and data}
library(MEMA)
library(limma)
library(data.table)
library(ggplot2)

data <- fread("~/Documents/MEMATestExp/LI8V004/Annotated Data/LI8V00407_14PopAnn.txt")

```
Develop a loess model of the CellMask signal of each array and normalize it by dividing the model by the array median.


```{r Create normalized loess model}
#' loessNormalize Create a median normalized loess model of an array
#'
#'@param data A dataframe with ArrayRow, ArrayColumn and signal intensity columns
#'@param value The column name of the signal values
#'@param span The span value passed to loess. Values between 0 and 1 determine the 
#'proportion of the population to be included in the loess neighborhood.
#'@export
loessNormalize <- function(data, value, span){
  dataMedian <- median(data[[value]], na.rm = TRUE)
  dataModel <- loess(as.formula(paste0(value," ~ ArrayRow+ArrayColumn")), data,span=span)
  dataPredicted <- predict(dataModel)
  dataNormed <- dataPredicted/dataMedian
}


```

```{r Plot loess model, fig.width=4,fig.height=6}
#Add the loess normalized values of the CellMask on a per well basis
data <- data[,LoessNormed :=loessNormalize(.SD,value="Net.635",span=.1), by="Barcode,Well"]

plotPseudoimage <- function(DT){
  p <- ggplot(DT, aes(x=ArrayColumn,
    y=ArrayRow,colour=Net.635))+
    geom_point(size=3)+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    facet_wrap(~Well,ncol = 4)+
    scale_colour_gradient(low = "white", high = "red")+
    guides(colour = guide_legend(keywidth = .5, keyheight = .5))+
    ggtitle(paste("Tecan CellMask Signal for",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p))
}

setkey(data,Barcode)
for(barcode in unique(data$Barcode)){
  DT <- data[barcode]
    p <- ggplot(DT, aes(x=ArrayColumn,
    y=ArrayRow,colour=Net.635))+
    geom_point(size=2)+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    facet_wrap(~Well,ncol = 4)+
    scale_colour_gradient(low = "white", high = "red")+
    guides(colour = guide_legend(keywidth = .5, keyheight = .5))+
    ggtitle(paste("Tecan CellMask Signal for",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p))
}

for(barcode in unique(data$Barcode)){
  DT <- data[barcode]
    p <- ggplot(DT, aes(x=ArrayColumn,
    y=ArrayRow,colour=LoessNormed))+
    geom_point(size=2)+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    facet_wrap(~Well,ncol = 4)+
    scale_colour_gradient(low = "white", high = "red")+
    guides(colour = guide_legend(keywidth = .5, keyheight = .5))+
    ggtitle(paste("Loess Normalized Tecan CellMask Signal for",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p))
}

  
```
